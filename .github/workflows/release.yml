name: Publish to zed-industries/extensions

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate tag matches extension version
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          EXT_VERSION="$(grep -E '^version = ' extension.toml | head -n1 | sed -E 's/version = \"([^\"]+)\"/\1/')"

          if [ -z "$EXT_VERSION" ]; then
            echo "::error::Cannot read version from extension.toml"
            exit 1
          fi

          if [ "$TAG_VERSION" != "$EXT_VERSION" ]; then
            echo "::error::Tag version ($TAG_VERSION) does not match extension.toml version ($EXT_VERSION)"
            exit 1
          fi

          echo "Version check passed: $EXT_VERSION"

      - name: Auto PR to Zed Extensions
        uses: huacnlee/zed-extension-action@v2
        with:
          extension-name: lean4
          push-to: owlx56/extensions
        env:
          COMMITTER_TOKEN: ${{ secrets.COMMITTER_TOKEN }}
